name: BMC Seat Checker (UI Scraping)

on:
  # Schedule: 4:00 AM, 2:00 PM, 8:30 PM IST
  schedule:
    - cron: "30 22 * * *" # 4:00 AM IST
    - cron: "30 8 * * *" # 2:00 PM IST
    - cron: "0 15 * * *" # 8:30 PM IST

  # Manual trigger
  workflow_dispatch:

jobs:
  check-seats:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: ğŸ” Scrape BMC seat availability
        env:
          NOTIFICATION_URL: ${{ secrets.NOTIFICATION_URL }}
          COURSE_URL: ${{ secrets.COURSE_URL }}
          COURSE_NAME: ${{ secrets.COURSE_NAME }}
          COURSE_ID: ${{ secrets.COURSE_ID }}
          TIMEZONE: Asia/Kolkata
        run: npm start

      - name: ğŸ“Š Display results
        if: always()
        run: echo "âœ… Seat check completed at $(date)"

      - name: ğŸ“¸ Upload screenshot on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshot
          path: /tmp/nimas-debug.png
          if-no-files-found: ignore
